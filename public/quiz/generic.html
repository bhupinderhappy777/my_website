<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz Hub - Generic</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }
    header h1 {
      color: #667eea;
      font-size: 2.0em;
      margin-bottom: 10px;
    }
    .stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .stat-box {
      background: #f0f4ff;
      padding: 15px 30px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    .stat-label {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: #e0e0e0;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .tab-btn:hover { background: #d0d0d0; }
    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Browse Questions Tab */
    .domain-filter {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .domain-filter-left {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .domain-filter select {
      padding: 10px 20px;
      border: 2px solid #667eea;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .question-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .question-card {
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      padding: 25px;
      background: #fafafa;
      transition: all 0.3s;
    }
    .question-card:hover {
      border-color: #667eea;
      box-shadow: 0 5px 20px rgba(102,126,234,0.2);
    }
    .question-number {
      color: #667eea;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .question-text {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    .option {
      padding: 12px 20px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .option:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .option.selected {
      border-color: #667eea;
      background: #eef2ff;
    }
    .option.correct {
      background: #d4edda;
      border-color: #28a745;
    }
    .option.wrong {
      background: #f8d7da;
      border-color: #dc3545;
    }
    .show-answer-btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .show-answer-btn:hover { background: #5568d3; }
    .explanation {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #e7f3ff;
      border-left: 4px solid #667eea;
      border-radius: 8px;
    }
    .explanation.visible { display: block; }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    /* Mock Exam Tab */
    .exam-setup {
      background: #f8f9ff;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
    }
    .exam-setup h2 { color: #667eea; margin-bottom: 20px; }
    .exam-info {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    .info-item { text-align: center; }
    .info-value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    .info-label { color: #666; margin-top: 5px; }

    /* Exam In Progress */
    .exam-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9ff;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
    }
    .timer {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
      font-family: monospace;
    }
    .timer.warning { color: #ff6b6b; }
    .question-counter { font-size: 1.2em; color: #666; }
    .exam-question {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
    }
    .exam-nav {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }

    /* Results */
    .results { text-align: center; padding: 40px; }
    .score-display { font-size: 5em; font-weight: bold; margin: 30px 0; }
    .pass { color: #28a745; }
    .fail { color: #dc3545; }
    .result-status { font-size: 2em; margin-bottom: 20px; }
    .domain-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 40px;
      text-align: left;
    }
    .domain-result {
      background: #f8f9ff;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    .domain-name { font-weight: 600; color: #667eea; margin-bottom: 10px; }
    .domain-score { font-size: 1.5em; font-weight: bold; }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px;
      color: #667eea;
      font-size: 1.1em;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .stats { flex-direction: column; align-items: center; }
      .exam-info { flex-direction: column; }
      .exam-header { flex-direction: column; gap: 15px; }
      .domain-filter { gap: 15px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üå©Ô∏è Quiz Hub - Generic</h1>
      <div class="stats">
        <div class="stat-box">
          <div class="stat-number" id="totalQuestions">0</div>
          <div class="stat-label">Total Questions</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="totalDomains">_</div>
          <div class="stat-label">Domains</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="examsCompleted">0</div>
          <div class="stat-label">Exams Completed</div>
        </div>
      </div>
    </header>

    <nav class="nav-tabs">
      <button class="tab-btn active" onclick="switchTab('browse', this)">üìö Browse Questions</button>
      <button class="tab-btn" onclick="switchTab('mock', this)">üéØ Mock Exam (90 min)</button>
      <button class="tab-btn" onclick="switchTab('custom', this)">‚öôÔ∏è Custom Exam</button>
      <button class="tab-btn" onclick="switchTab('stats', this)">üìä Statistics</button>
    </nav>

    <!-- Browse Questions Tab -->
    <div id="browse-tab" class="tab-content active">
      <div class="domain-filter">
        <div class="domain-filter-left">
          <label for="domainSelect" style="font-weight: 600;">Filter by Domain:</label>
          <select id="domainSelect" onchange="filterByDomain()">
            <option value="all">All Domains</option>
          </select>
        </div>
        <div>
          <button class="btn btn-primary" onclick="openFilePicker()">üìÅ Load JSON file</button>
        </div>
      </div>
      <div id="questionList" class="question-list">
        <div class="loading">
          <div class="spinner"></div>
          Loading questions...
        </div>
      </div>
    </div>

    <!-- Mock Exam Tab -->
    <div id="mock-tab" class="tab-content">
      <div id="examSetup" class="exam-setup">
        <h2>Full Mock Exam</h2>
        <p style="color: #666; margin-bottom: 20px;">
          Simulates the real exam experience
        </p>
        <div class="exam-info">
          <div class="info-item">
            <div class="info-value">90</div>
            <div class="info-label">Questions</div>
          </div>
          <div class="info-item">
            <div class="info-value">90</div>
            <div class="info-label">Minutes</div>
          </div>
          <div class="info-item">
            <div class="info-value">750</div>
            <div class="info-label">Passing Score</div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="startMockExam()">Start Mock Exam</button>
      </div>

      <div id="examInProgress" style="display: none;">
        <div class="exam-header">
          <div class="question-counter" id="questionCounter">Question 1 of 90</div>
          <div class="timer" id="timer">90:00</div>
          <button class="btn btn-secondary" onclick="endExam()">End Exam</button>
        </div>
        <div id="examQuestionContainer"></div>
        <div class="exam-nav">
          <button class="btn btn-secondary" onclick="previousQuestion()" id="prevBtn">‚Üê Previous</button>
          <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn">Next ‚Üí</button>
        </div>
      </div>

      <div id="examResults" style="display: none;"></div>
    </div>

    <!-- Custom Exam Tab -->
    <div id="custom-tab" class="tab-content">
      <div class="custom-exam-form">
        <h2 style="color: #667eea; margin-bottom: 25px;">Create Custom Exam</h2>

        <div class="form-group">
          <label for="customQuestions">Number of Questions (1-90):</label>
          <input type="number" id="customQuestions" min="1" max="90" value="30">
        </div>

        <div class="form-group">
          <label for="customTime">Time Limit (minutes):</label>
          <input type="number" id="customTime" min="1" max="180" value="30">
        </div>

        <div class="form-group">
          <label>Select Domains:</label>
          <div class="checkbox-group" id="domainCheckboxes">
            <!-- Populated dynamically -->
          </div>
        </div>

        <button class="btn btn-primary" onclick="startCustomExam()">Start Custom Exam</button>
      </div>
    </div>

    <!-- Statistics Tab -->
    <div id="stats-tab" class="tab-content">
      <h2 style="color: #667eea; margin-bottom: 25px;">Your Performance Statistics</h2>
      <div id="statsContent">
        <p style="color: #666; text-align: center; padding: 40px;">
          Complete an exam to see your performance statistics here.
        </p>
      </div>
    </div>
  </div>

  <!-- Hidden file input (works in file:// or http://) -->
  <input type="file" id="qfile" accept=".json" style="display:none" />

  <!-- Built-in sample questions removed. Use the file picker to load questions.json. -->

  <script>
    // ===== Global state =====
    let allQuestions = {};
    let currentExamQuestions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let timerInterval = null;
    let timeRemaining = 0;
    let examHistory = JSON.parse(localStorage.getItem('examHistory') || '[]');

    // ===== Domain weights for mock exam =====
    const domainWeights = {
      "1. Cloud Architecture": 0.23,
      "2. Deployment": 0.19,
      "3. Security": 0.19,
      "4. Operations": 0.17,
      "5. DevOps Fundamentals": 0.10,
      "6. Troubleshooting": 0.12
    };

    // ===== Utilities =====
    function openFilePicker() {
      document.getElementById('qfile').value = "";
      document.getElementById('qfile').click();
    }

    function readInlineQuestions() {
      try {
        const el = document.getElementById('questions-inline');
        if (!el) return null;
        const txt = el.textContent.trim();
        if (!txt) return null;
        const data = JSON.parse(txt);
        if (data && typeof data === 'object' && Object.keys(data).length > 0) return data;
      } catch (e) {
        console.warn('Inline JSON invalid:', e);
      }
      return null;
    }

    // ===== Init (handles file:// and http://) =====
    async function init() {
      // Wire up file loader (works on both file:// and http(s)://)
      document.getElementById('qfile').addEventListener('change', handleLocalJsonSelected);

      const inlineData = readInlineQuestions();

      if (location.protocol === 'file:') {
        // In file://, fetch() to local files is blocked. Use inline data (if present) or ask user to load a JSON file.
        if (inlineData) {
          allQuestions = inlineData;
          afterQuestionsLoaded();
          showInfoBanner('Loaded built-in sample questions. Use "Load JSON file" to load your own.');
        } else {
          showChooseJsonUI();
        }
      } else {
        // http/https: try fetch first; fallback to inline on error
        try {
          await loadQuestionsViaFetch();
          afterQuestionsLoaded();
        } catch (e) {
          console.warn('Fetch failed, falling back to inline JSON:', e);
          if (inlineData) {
            allQuestions = inlineData;
            afterQuestionsLoaded();
            showInfoBanner('Could not fetch questions.json. Using built-in sample questions.');
          } else {
            showFetchError(e);
          }
        }
      }
    }

    function showChooseJsonUI() {
      const container = document.getElementById('questionList');
      container.innerHTML = `
        <div class="loading" style="padding: 40px;">
          <div class="spinner"></div>
          This page is opened using <code>file://</code>, so the browser blocks <code>fetch()</code> to local files.
          <br/><br/>
          <button class="btn btn-primary" onclick="openFilePicker()">üìÅ Choose questions.json</button>
          <p style="color:#666; margin-top:10px;">
            Tip: Or run a local server (e.g., <code>python -m http.server 5500</code>) and open via <code>http://</code>.
          </p>
        </div>
      `;
    }

    function showFetchError(err) {
      const container = document.getElementById('questionList');
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #dc3545;">
          <h3>‚ùå Error Loading Questions</h3>
          <p style="margin-top: 15px;">Could not load <code>questions.json</code> via HTTP.</p>
          <pre style="text-align:left; overflow:auto; white-space:pre-wrap; background:#f8d7da; padding:10px; border-radius:8px;">${String(err)}</pre>
          <div style="margin-top:12px;">
            <button class="btn btn-primary" onclick="openFilePicker()">üìÅ Load JSON file</button>
          </div>
        </div>
      `;
    }

    function showInfoBanner(msg) {
      const container = document.getElementById('questionList');
      const banner = document.createElement('div');
      banner.style.cssText = 'padding:12px; margin-bottom:10px; background:#e7f3ff; border-left:4px solid #667eea; border-radius:8px; color:#333;';
      banner.innerHTML = msg;
      container.prepend(banner);
    }

    // ===== Loaders =====
    async function loadQuestionsViaFetch() {
      const res = await fetch('./questions.json', { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      allQuestions = await res.json();
    }

    function handleLocalJsonSelected(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          allQuestions = JSON.parse(reader.result);
          afterQuestionsLoaded();
          showInfoBanner(`Loaded questions from file: <strong>${file.name}</strong>`);
        } catch (err) {
          const container = document.getElementById('questionList');
          container.innerHTML = `
            <div style="text-align:center; padding:40px; color:#dc3545;">
              <h3>‚ùå Invalid JSON</h3>
              <p style="margin-top:10px; color:#666;">Make sure you selected the correct <code>questions.json</code> file.</p>
              <pre style="text-align:left; overflow:auto; white-space:pre-wrap; background:#f8d7da; padding:10px; border-radius:8px;">${err.message}</pre>
            </div>
          `;
          console.error('Invalid JSON:', err);
        }
      };
      reader.onerror = () => {
        const container = document.getElementById('questionList');
        container.innerHTML = `
          <div style="text-align:center; padding:40px; color:#dc3545;">
            <h3>‚ùå Could not read file</h3>
            <p style="margin-top:10px; color:#666;">Please try selecting the file again.</p>
          </div>
        `;
      };
      reader.readAsText(file, 'utf-8');
    }

    // ===== After data is ready =====
    function afterQuestionsLoaded() {
      // Total questions
      let totalCount = 0;
      Object.values(allQuestions).forEach(domainQuestions => { totalCount += domainQuestions.length; });
      document.getElementById('totalQuestions').textContent = totalCount;

      // Populate domain controls
      populateDomainControls();

      // Show all
      displayQuestions('all');

      // Stats
      updateStats();
    }

    // ===== UI rendering =====
    function populateDomainControls() {
      const select = document.getElementById('domainSelect');
      const checkboxContainer = document.getElementById('domainCheckboxes');
      // Reset
      select.querySelectorAll('option:not([value="all"])').forEach(o => o.remove());
      checkboxContainer.innerHTML = '';

      const domains = Object.keys(allQuestions);
      domains.forEach((domain, i) => {
        // Dropdown
        const option = document.createElement('option');
        option.value = domain;
        option.textContent = `${domain} (${allQuestions[domain].length} questions)`;
        select.appendChild(option);

        // Checkboxes (use numeric id to avoid special char issues)
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'checkbox-item';
        const cid = `domain-${i}`;
        checkboxDiv.innerHTML = `
          <input type="checkbox" id="${cid}" value="${domain}" checked>
          <label for="${cid}">${domain}</label>
        `;
        checkboxContainer.appendChild(checkboxDiv);
      });
    }

    function displayQuestions(domain) {
      const container = document.getElementById('questionList');
      container.innerHTML = '';

      let questionsToDisplay = [];
      if (domain === 'all') {
        Object.entries(allQuestions).forEach(([domainName, questions]) => {
          questions.forEach((q, idx) => {
            questionsToDisplay.push({ ...q, domain: domainName, number: idx + 1 });
          });
        });
      } else {
        (allQuestions[domain] || []).forEach((q, idx) => {
          questionsToDisplay.push({ ...q, domain: domain, number: idx + 1 });
        });
      }

      questionsToDisplay.forEach((q, globalIdx) => {
        const card = createQuestionCard(q, globalIdx);
        container.appendChild(card);
      });

      if (questionsToDisplay.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'loading';
        empty.textContent = 'No questions to display for this filter.';
        container.appendChild(empty);
      }
    }

    function createQuestionCard(question, index) {
      const card = document.createElement('div');
      card.className = 'question-card';

      const optionsHTML = question.options.map((opt, i) =>
        `<div class="option" onclick="selectOption(${index}, ${i})" id="option-${index}-${i}">${opt}</div>`
      ).join('');

      card.innerHTML = `
        <div class="question-number">${question.domain} - Question ${question.number}</div>
        <div class="question-text">${question.q}</div>
        <div class="options">${optionsHTML}</div>
        <button class="show-answer-btn" onclick="showAnswer(${index})">Show Answer & Explanation</button>
        <div class="explanation" id="explanation-${index}">
          <strong>‚úÖ Correct Answer: ${question.options[question.answer]}</strong><br><br>
          ${question.explanation}
        </div>
      `;
      return card;
    }

    function filterByDomain() {
      const domain = document.getElementById('domainSelect').value;
      displayQuestions(domain);
    }

    function selectOption(questionIndex, optionIndex) {
      // Clear any previously selected option for this question
      document.querySelectorAll(`[id^="option-${questionIndex}-"]`).forEach(el => el.classList.remove('selected'));
      const selected = document.getElementById(`option-${questionIndex}-${optionIndex}`);
      if (selected) selected.classList.add('selected');
    }

    function showAnswer(questionIndex) {
      const explanation = document.getElementById(`explanation-${questionIndex}`);
      explanation.classList.toggle('visible');
    }

    function switchTab(tabName, btnEl) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      if (btnEl) btnEl.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      const target = document.getElementById(`${tabName}-tab`);
      if (target) target.classList.add('active');
    }

    // ===== Mock Exam =====
    function startMockExam() {
      currentExamQuestions = generateMockExam();
      currentQuestionIndex = 0;
      userAnswers = new Array(currentExamQuestions.length).fill(null);
      timeRemaining = 90 * 60;

      document.getElementById('examSetup').style.display = 'none';
      document.getElementById('examInProgress').style.display = 'block';

      startTimer();
      displayExamQuestion();
    }

    function generateMockExam() {
      const examQuestions = [];
      Object.entries(domainWeights).forEach(([domain, weight]) => {
        const domainQuestions = allQuestions[domain] || [];
        const numQuestions = Math.round(90 * weight);
        const shuffled = [...domainQuestions].sort(() => Math.random() - 0.5);
        const selected = shuffled.slice(0, Math.min(numQuestions, shuffled.length));
        examQuestions.push(...selected.map(q => ({ ...q, domain })));
      });
      return examQuestions.sort(() => Math.random() - 0.5).slice(0, 90);
    }

    // ===== Custom Exam =====
    function startCustomExam() {
      const numQuestions = parseInt(document.getElementById('customQuestions').value, 10);
      const timeLimit = parseInt(document.getElementById('customTime').value, 10);

      const selectedDomains = [];
      document.querySelectorAll('#domainCheckboxes input[type="checkbox"]:checked')
        .forEach(cb => selectedDomains.push(cb.value));

      if (selectedDomains.length === 0) {
        alert('Please select at least one domain!');
        return;
      }

      let availableQuestions = [];
      selectedDomains.forEach(domain => {
        const domainQuestions = allQuestions[domain] || [];
        availableQuestions.push(...domainQuestions.map(q => ({ ...q, domain })));
      });

      const shuffled = availableQuestions.sort(() => Math.random() - 0.5);
      currentExamQuestions = shuffled.slice(0, Math.min(numQuestions, shuffled.length));

      currentQuestionIndex = 0;
      userAnswers = new Array(currentExamQuestions.length).fill(null);
      timeRemaining = timeLimit * 60;

      document.querySelectorAll('.tab-btn')[1].click(); // go to Mock tab
      document.getElementById('examSetup').style.display = 'none';
      document.getElementById('examInProgress').style.display = 'block';

      startTimer();
      displayExamQuestion();
    }

    // ===== Timer & Exam Nav =====
    function startTimer() {
      const timerDisplay = document.getElementById('timer');
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeRemaining--;
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        if (timeRemaining <= 300) timerDisplay.classList.add('warning');
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          endExam();
        }
      }, 1000);
    }

    function displayExamQuestion() {
      const question = currentExamQuestions[currentQuestionIndex];
      const container = document.getElementById('examQuestionContainer');

      document.getElementById('questionCounter').textContent =
        `Question ${currentQuestionIndex + 1} of ${currentExamQuestions.length}`;

      const optionsHTML = question.options.map((opt, i) =>
        `<div class="option ${userAnswers[currentQuestionIndex] === i ? 'selected' : ''}"
             onclick="selectExamOption(${i})" id="exam-option-${i}">${opt}</div>`
      ).join('');

      container.innerHTML = `
        <div class="exam-question">
          <div class="question-number">${question.domain}</div>
          <div class="question-text">${question.q}</div>
          <div class="options">${optionsHTML}</div>
        </div>
      `;

      document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
      document.getElementById('nextBtn').textContent =
        currentQuestionIndex === currentExamQuestions.length - 1 ? 'Finish Exam' : 'Next ‚Üí';
    }

    function selectExamOption(optionIndex) {
      userAnswers[currentQuestionIndex] = optionIndex;
      document.querySelectorAll(`[id^="exam-option-"]`).forEach(el => el.classList.remove('selected'));
      const sel = document.getElementById(`exam-option-${optionIndex}`);
      if (sel) sel.classList.add('selected');
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayExamQuestion();
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < currentExamQuestions.length - 1) {
        currentQuestionIndex++;
        displayExamQuestion();
      } else {
        endExam();
      }
    }

    // ===== Results & Stats =====
    function endExam() {
      clearInterval(timerInterval);

      let correct = 0;
      let domainScores = {};

      currentExamQuestions.forEach((question, i) => {
        const domain = question.domain;
        if (!domainScores[domain]) domainScores[domain] = { correct: 0, total: 0 };
        domainScores[domain].total++;
        if (userAnswers[i] === question.answer) {
          correct++;
          domainScores[domain].correct++;
        }
      });

      const score = Math.round((correct / currentExamQuestions.length) * 900);
      const passed = score >= 750;

      examHistory.push({
        date: new Date().toISOString(),
        score, correct,
        total: currentExamQuestions.length,
        passed,
        domainScores
      });
      localStorage.setItem('examHistory', JSON.stringify(examHistory));

      const resultsContainer = document.getElementById('examResults');
      const domainBreakdownHTML = Object.entries(domainScores).map(([domain, scores]) => `
        <div class="domain-result">
          <div class="domain-name">${domain}</div>
          <div class="domain-score">${scores.correct}/${scores.total} (${Math.round(scores.correct/scores.total*100)}%)</div>
        </div>
      `).join('');

      resultsContainer.innerHTML = `
        <div class="results">
          <h2 class="result-status">${passed ? 'üéâ Congratulations!' : 'üìö Keep Studying!'}</h2>
          <div class="score-display ${passed ? 'pass' : 'fail'}">${score}</div>
          <p style="font-size: 1.5em; color: #666;">
            ${correct} out of ${currentExamQuestions.length} correct (${Math.round(correct/currentExamQuestions.length*100)}%)
          </p>
          <p style="margin-top: 20px; font-size: 1.2em;">
            ${passed ? 'You passed! Great job! üéØ' : 'Passing score is 750. Review weak areas and try again.'}
          </p>

          <h3 style="margin-top: 40px; color: #667eea;">Domain Breakdown</h3>
          <div class="domain-breakdown">${domainBreakdownHTML}</div>

          <button class="btn btn-primary" onclick="resetExam()" style="margin-top: 40px;">Back to Setup</button>
        </div>
      `;

      document.getElementById('examInProgress').style.display = 'none';
      resultsContainer.style.display = 'block';

      updateStats();
    }

    function resetExam() {
      document.getElementById('examSetup').style.display = 'block';
      document.getElementById('examInProgress').style.display = 'none';
      document.getElementById('examResults').style.display = 'none';
    }

    function updateStats() {
      document.getElementById('examsCompleted').textContent = examHistory.length;
      if (examHistory.length === 0) return;

      const statsContent = document.getElementById('statsContent');
      const avgScore = Math.round(examHistory.reduce((sum, exam) => sum + exam.score, 0) / examHistory.length);
      const passRate = Math.round((examHistory.filter(exam => exam.passed).length / examHistory.length) * 100);

      const recentExams = examHistory.slice(-5).reverse().map(exam => `
        <div class="domain-result">
          <div class="domain-name">${new Date(exam.date).toLocaleDateString()}</div>
          <div class="domain-score ${exam.passed ? 'pass' : 'fail'}">${exam.score} ${exam.passed ? '‚úÖ' : '‚ùå'}</div>
          <div style="color: #666; font-size: 0.9em; margin-top: 5px;">${exam.correct}/${exam.total} correct</div>
        </div>
      `).join('');

      statsContent.innerHTML = `
        <div class="exam-info">
          <div class="info-item">
            <div class="info-value">${avgScore}</div>
            <div class="info-label">Average Score</div>
          </div>
          <div class="info-item">
            <div class="info-value">${passRate}%</div>
            <div class="info-label">Pass Rate</div>
          </div>
          <div class="info-item">
            <div class="info-value">${examHistory.length}</div>
            <div class="info-label">Total Exams</div>
          </div>
        </div>

        <h3 style="color: #667eea; margin: 30px 0 20px 0;">Recent Exams</h3>
        <div class="domain-breakdown">${recentExams}</div>
      `;
    }

    // ===== Start =====
    window.onload = init;
  </script>
</body>
</html>